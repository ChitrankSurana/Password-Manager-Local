{% extends "base.html" %}

{% block title %}Edit Password - Personal Password Manager{% endblock %}

{% block content %}
<div class="dashboard-container">
    <div class="dashboard-header">
        <div class="dashboard-title">
            <h1>Edit Password</h1>
            <p>Update password information for {{ password.website }}</p>
        </div>
        
        <div class="dashboard-actions">
            <a href="{{ url_for('dashboard') }}" class="btn-secondary">
                <i class="fas fa-arrow-left"></i>
                Back to Dashboard
            </a>
        </div>
    </div>
    
    <div class="password-form-container">
        <form class="password-form" method="POST" action="{{ url_for('edit_password', password_id=password.id) }}" novalidate>
            <div class="form-row">
                <div class="form-group">
                    <label for="website" class="required">
                        <i class="fas fa-globe"></i>
                        Website or Service
                    </label>
                    <input 
                        type="text" 
                        id="website" 
                        name="website" 
                        required 
                        placeholder="e.g., Gmail, Facebook, GitHub"
                        value="{{ password.website }}"
                        autocomplete="off"
                    >
                    <small class="form-help">The name of the website or service</small>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="username" class="required">
                        <i class="fas fa-user"></i>
                        Username or Email
                    </label>
                    <input 
                        type="text" 
                        id="username" 
                        name="username" 
                        required 
                        placeholder="your.email@example.com"
                        value="{{ password.username }}"
                        autocomplete="username"
                    >
                    <small class="form-help">Your login username or email address</small>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="password" class="required">
                        <i class="fas fa-key"></i>
                        Password
                    </label>
                    <div class="password-input-group">
                        <input 
                            type="password" 
                            id="password" 
                            name="password" 
                            required 
                            placeholder="Enter or generate a strong password"
                            value="{{ password.password }}"
                            autocomplete="new-password"
                            oninput="handlePasswordInput()"
                        >
                        <button type="button" class="password-toggle" onclick="togglePasswordVisibility('password')">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                    
                    <!-- Password strength indicator -->
                    <div class="password-strength" id="passwordStrength" style="display: none;">
                        <div class="strength-bar">
                            <div class="strength-fill"></div>
                        </div>
                        <div class="strength-text"></div>
                        <div class="strength-suggestions" id="strengthSuggestions"></div>
                    </div>
                    
                    <!-- Password generation tools -->
                    <div class="password-tools">
                        <button type="button" class="btn-secondary btn-sm" onclick="showPasswordGenerator()">
                            <i class="fas fa-dice"></i>
                            Generate New Password
                        </button>
                        <button type="button" class="btn-secondary btn-sm" onclick="revertOriginalPassword()">
                            <i class="fas fa-undo"></i>
                            Revert to Original
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="remarks">
                        <i class="fas fa-sticky-note"></i>
                        Remarks (Optional)
                    </label>
                    <textarea 
                        id="remarks" 
                        name="remarks" 
                        rows="3" 
                        placeholder="Add any notes about this account (recovery info, security questions, etc.)"
                    >{{ password.remarks or '' }}</textarea>
                    <small class="form-help">Optional notes about this password or account</small>
                </div>
            </div>
            
            <div class="form-meta">
                <div class="meta-info">
                    <div class="meta-item">
                        <span class="meta-label">Created:</span>
                        <span class="meta-value">{{ password.created_at.strftime('%Y-%m-%d %H:%M') if password.created_at else 'Unknown' }}</span>
                    </div>
                    <div class="meta-item">
                        <span class="meta-label">Last Updated:</span>
                        <span class="meta-value">{{ password.updated_at.strftime('%Y-%m-%d %H:%M') if password.updated_at else 'Unknown' }}</span>
                    </div>
                </div>
            </div>
            
            <div class="form-actions">
                <button type="submit" class="btn-primary" id="saveBtn">
                    <i class="fas fa-save"></i>
                    Update Password
                </button>
                <button type="button" class="btn-secondary" onclick="resetForm()">
                    <i class="fas fa-undo"></i>
                    Reset Changes
                </button>
                <button type="button" class="btn-danger" onclick="confirmDelete()">
                    <i class="fas fa-trash"></i>
                    Delete Password
                </button>
            </div>
        </form>
        
        <!-- Change History -->
        <div class="change-history" style="display: none;">
            <h3><i class="fas fa-history"></i> Change History</h3>
            <div class="history-list">
                <!-- History items would be populated here -->
            </div>
        </div>
        
        <!-- Security Notice -->
        <div class="security-notice">
            <div class="notice-content">
                <i class="fas fa-shield-alt"></i>
                <div>
                    <h4>Security Note</h4>
                    <p>Changes to your password will be encrypted and stored securely. Consider updating the password on the actual website as well.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Password Generator Modal (same as add_password.html) -->
<div id="generatorModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2><i class="fas fa-dice"></i> Password Generator</h2>
            <button class="modal-close" onclick="closeModal('generatorModal')">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <div class="generator-settings">
                <div class="form-group">
                    <label for="generatorLength">Length: <span id="lengthValue">16</span></label>
                    <input 
                        type="range" 
                        id="generatorLength" 
                        min="8" 
                        max="64" 
                        value="16" 
                        class="range-slider"
                        oninput="updateLengthValue(this.value)"
                    >
                </div>
                
                <div class="form-group">
                    <label>Character Types:</label>
                    <div class="checkbox-grid">
                        <div class="checkbox-group">
                            <input type="checkbox" id="includeLowercase" checked>
                            <label for="includeLowercase">Lowercase (a-z)</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="includeUppercase" checked>
                            <label for="includeUppercase">Uppercase (A-Z)</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="includeDigits" checked>
                            <label for="includeDigits">Digits (0-9)</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="includeSymbols" checked>
                            <label for="includeSymbols">Symbols (!@#$)</label>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="generatorMethod">Generation Method:</label>
                    <select id="generatorMethod">
                        <option value="random">Random (Most Secure)</option>
                        <option value="memorable">Memorable (Easier to remember)</option>
                        <option value="pronounceable">Pronounceable (Sounds like words)</option>
                    </select>
                </div>
                
                <div class="generated-password">
                    <label>Generated Password:</label>
                    <div class="password-display">
                        <input type="text" id="generatedPassword" readonly>
                        <button type="button" class="copy-btn" onclick="copyGeneratedPassword()">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                    <div class="password-strength" id="generatedStrength">
                        <div class="strength-bar">
                            <div class="strength-fill"></div>
                        </div>
                        <div class="strength-text"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn-secondary" onclick="generateNewPassword()">
                <i class="fas fa-refresh"></i>
                Generate New
            </button>
            <button type="button" class="btn-primary" onclick="useGeneratedPassword()">
                <i class="fas fa-check"></i>
                Use This Password
            </button>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteModal" class="modal">
    <div class="modal-content modal-sm">
        <div class="modal-header">
            <h2>Confirm Deletion</h2>
            <button class="modal-close" onclick="closeModal('deleteModal')">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <div class="delete-warning">
                <i class="fas fa-exclamation-triangle"></i>
                <p>Are you sure you want to delete the password for <strong>{{ password.website }}</strong>?</p>
                <p class="warning-text">This action cannot be undone.</p>
            </div>
        </div>
        <div class="modal-footer">
            <form method="POST" action="{{ url_for('delete_password', password_id=password.id) }}" style="display: inline;">
                <button type="submit" class="btn-danger">
                    <i class="fas fa-trash"></i> Delete
                </button>
            </form>
            <button class="btn-secondary" onclick="closeModal('deleteModal')">Cancel</button>
        </div>
    </div>
</div>

<style>
/* Inherit styles from add_password.html */
.password-form-container {
    max-width: 600px;
    margin: 0 auto;
}

.password-form {
    background-color: var(--bg-surface);
    border-radius: var(--radius-lg);
    padding: var(--spacing-xl);
    box-shadow: 0 2px 8px var(--shadow-light);
    margin-bottom: var(--spacing-xl);
}

.form-row {
    margin-bottom: var(--spacing-lg);
}

.password-tools {
    display: flex;
    gap: var(--spacing-sm);
    margin-top: var(--spacing-sm);
    flex-wrap: wrap;
}

.btn-sm {
    padding: var(--spacing-sm) var(--spacing-md);
    font-size: var(--font-size-sm);
}

.form-actions {
    display: flex;
    gap: var(--spacing-md);
    justify-content: flex-start;
    margin-top: var(--spacing-xl);
    flex-wrap: wrap;
}

.form-meta {
    background-color: var(--bg-secondary);
    border-radius: var(--radius-md);
    padding: var(--spacing-md);
    margin-bottom: var(--spacing-lg);
}

.meta-info {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: var(--spacing-md);
}

.meta-item {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-xs);
}

.meta-label {
    font-size: var(--font-size-sm);
    color: var(--text-secondary);
    font-weight: 500;
}

.meta-value {
    font-size: var(--font-size-sm);
    color: var(--text-primary);
    font-family: 'Monaco', 'Consolas', monospace;
}

.change-history {
    background-color: var(--bg-surface);
    border-radius: var(--radius-lg);
    padding: var(--spacing-lg);
    box-shadow: 0 2px 8px var(--shadow-light);
    margin-bottom: var(--spacing-xl);
}

.change-history h3 {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
    margin-bottom: var(--spacing-md);
    color: var(--text-primary);
}

.security-notice {
    background-color: var(--bg-surface);
    border-radius: var(--radius-lg);
    padding: var(--spacing-lg);
    box-shadow: 0 2px 8px var(--shadow-light);
    border-left: 4px solid var(--warning);
}

.notice-content {
    display: flex;
    align-items: flex-start;
    gap: var(--spacing-md);
}

.notice-content i {
    color: var(--warning);
    font-size: var(--font-size-xl);
    margin-top: var(--spacing-xs);
}

.notice-content h4 {
    margin-bottom: var(--spacing-xs);
    color: var(--text-primary);
}

.notice-content p {
    margin: 0;
    color: var(--text-secondary);
    font-size: var(--font-size-sm);
}

.delete-warning {
    text-align: center;
    padding: var(--spacing-md);
}

.delete-warning i {
    font-size: 3rem;
    color: var(--danger);
    margin-bottom: var(--spacing-md);
}

.delete-warning p {
    margin-bottom: var(--spacing-sm);
}

.warning-text {
    font-size: var(--font-size-sm);
    color: var(--text-secondary);
    font-style: italic;
}

.required::after {
    content: " *";
    color: var(--danger);
}

/* Generator styles - same as add_password.html */
.generator-settings .form-group {
    margin-bottom: var(--spacing-lg);
}

.checkbox-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: var(--spacing-sm);
    margin-top: var(--spacing-sm);
}

.generated-password {
    margin-top: var(--spacing-lg);
    padding: var(--spacing-md);
    background-color: var(--bg-secondary);
    border-radius: var(--radius-md);
}

.password-display {
    display: flex;
    gap: var(--spacing-sm);
    margin-bottom: var(--spacing-sm);
}

.password-display input {
    flex: 1;
    font-family: 'Monaco', 'Consolas', monospace;
    font-size: var(--font-size-md);
}

.copy-btn {
    padding: var(--spacing-sm);
    background-color: var(--primary);
    color: white;
    border: none;
    border-radius: var(--radius-sm);
    cursor: pointer;
    transition: background-color var(--transition-fast);
}

.copy-btn:hover {
    background-color: var(--primary-hover);
}

.range-slider {
    width: 100%;
    height: 6px;
    border-radius: 3px;
    background-color: var(--border-color);
    outline: none;
    -webkit-appearance: none;
}

.range-slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background-color: var(--primary);
    cursor: pointer;
}

.range-slider::-moz-range-thumb {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background-color: var(--primary);
    cursor: pointer;
    border: none;
}

@media (max-width: 768px) {
    .password-form {
        padding: var(--spacing-lg);
    }
    
    .form-actions {
        flex-direction: column;
    }
    
    .form-actions button {
        width: 100%;
    }
    
    .checkbox-grid {
        grid-template-columns: 1fr;
    }
    
    .password-tools {
        flex-direction: column;
    }
    
    .meta-info {
        grid-template-columns: 1fr;
    }
}
</style>

<script>
let strengthCheckTimeout;
let currentPassword = '';
let originalPassword = '{{ password.password }}';

function handlePasswordInput() {
    const password = document.getElementById('password').value;
    currentPassword = password;
    
    if (password.length > 0) {
        checkPasswordStrengthDelayed(password);
    } else {
        hidePasswordStrength();
    }
}

function checkPasswordStrengthDelayed(password) {
    clearTimeout(strengthCheckTimeout);
    
    strengthCheckTimeout = setTimeout(async () => {
        try {
            const analysis = await checkPasswordStrength(password);
            updatePasswordStrength(analysis);
        } catch (error) {
            console.error('Strength check failed:', error);
        }
    }, 500);
}

function updatePasswordStrength(analysis) {
    const strengthDiv = document.getElementById('passwordStrength');
    const fill = strengthDiv.querySelector('.strength-fill');
    const text = strengthDiv.querySelector('.strength-text');
    const suggestions = document.getElementById('strengthSuggestions');
    
    strengthDiv.style.display = 'block';
    
    const progress = analysis.progress || 0;
    const level = analysis.strength_level || 'very_weak';
    
    fill.style.width = progress + '%';
    fill.className = 'strength-fill strength-' + level;
    text.textContent = analysis.strength_level.replace('_', ' ').toUpperCase() + 
                     ' (' + analysis.strength_score + '/100)';
    
    // Show suggestions if available
    if (analysis.suggestions && analysis.suggestions.length > 0) {
        suggestions.innerHTML = '<strong>Suggestions to improve:</strong><ul>' +
            analysis.suggestions.map(s => '<li>' + s + '</li>').join('') +
            '</ul>';
        suggestions.style.display = 'block';
    } else {
        suggestions.style.display = 'none';
    }
}

function hidePasswordStrength() {
    document.getElementById('passwordStrength').style.display = 'none';
}

function togglePasswordVisibility(inputId) {
    const input = document.getElementById(inputId);
    const button = input.nextElementSibling;
    const icon = button.querySelector('i');
    
    if (input.type === 'password') {
        input.type = 'text';
        icon.className = 'fas fa-eye-slash';
    } else {
        input.type = 'password';
        icon.className = 'fas fa-eye';
    }
}

function resetForm() {
    if (confirm('Are you sure you want to reset all changes?')) {
        document.getElementById('website').value = '{{ password.website }}';
        document.getElementById('username').value = '{{ password.username }}';
        document.getElementById('password').value = originalPassword;
        document.getElementById('remarks').value = '{{ password.remarks or '' }}';
        hidePasswordStrength();
        document.getElementById('website').focus();
    }
}

function revertOriginalPassword() {
    if (confirm('Revert to the original password?')) {
        document.getElementById('password').value = originalPassword;
        handlePasswordInput();
        showToast('Password reverted to original', 'info');
    }
}

function confirmDelete() {
    openModal('deleteModal');
}

function showPasswordGenerator() {
    openModal('generatorModal');
    generateNewPassword();
}

function updateLengthValue(value) {
    document.getElementById('lengthValue').textContent = value;
    generateNewPassword();
}

async function generateNewPassword() {
    const options = {
        length: parseInt(document.getElementById('generatorLength').value),
        include_lowercase: document.getElementById('includeLowercase').checked,
        include_uppercase: document.getElementById('includeUppercase').checked,
        include_digits: document.getElementById('includeDigits').checked,
        include_symbols: document.getElementById('includeSymbols').checked,
        method: document.getElementById('generatorMethod').value
    };
    
    try {
        const result = await generatePassword(options);
        document.getElementById('generatedPassword').value = result.password;
        
        if (result.strength) {
            updateGeneratedPasswordStrength(result.strength);
        }
    } catch (error) {
        showToast('Failed to generate password', 'error');
    }
}

function updateGeneratedPasswordStrength(analysis) {
    const strengthDiv = document.getElementById('generatedStrength');
    const fill = strengthDiv.querySelector('.strength-fill');
    const text = strengthDiv.querySelector('.strength-text');
    
    const progress = analysis.progress || 0;
    const level = analysis.strength_level || 'very_weak';
    
    fill.style.width = progress + '%';
    fill.className = 'strength-fill strength-' + level;
    text.textContent = analysis.strength_level.replace('_', ' ').toUpperCase() + 
                     ' (' + analysis.strength_score + '/100)';
}

function copyGeneratedPassword() {
    const password = document.getElementById('generatedPassword').value;
    copyToClipboard(password, 'Generated password copied!');
}

function useGeneratedPassword() {
    const password = document.getElementById('generatedPassword').value;
    document.getElementById('password').value = password;
    closeModal('generatorModal');
    handlePasswordInput();
    showToast('New password applied successfully!', 'success');
}

// Auto-focus first field on page load
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('website').focus();
    
    // Check initial password strength
    const password = document.getElementById('password').value;
    if (password) {
        handlePasswordInput();
    }
    
    // Setup form validation
    const form = document.querySelector('.password-form');
    form.addEventListener('submit', function(e) {
        if (!validateForm(this)) {
            e.preventDefault();
            showToast('Please fill in all required fields', 'error');
        }
    });
    
    // Listen for generator setting changes
    const generatorInputs = document.querySelectorAll('#generatorModal input, #generatorModal select');
    generatorInputs.forEach(input => {
        input.addEventListener('change', generateNewPassword);
    });
});
</script>
{% endblock %}