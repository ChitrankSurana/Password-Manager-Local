{% extends "base.html" %}

{% block title %}Dashboard - Personal Password Manager{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- Dashboard Header -->
    <div class="dashboard-header">
        <div class="dashboard-title">
            <h1>Welcome, {{ username }}!</h1>
            <p>You have {{ password_count }} passwords stored securely</p>
        </div>
        
        <div class="dashboard-actions">
            <a href="{{ url_for('add_password') }}" class="btn-primary">
                <i class="fas fa-plus"></i>
                Add Password
            </a>
            <a href="{{ url_for('generate_password_page') }}" class="btn-secondary">
                <i class="fas fa-dice"></i>
                Generate
            </a>
        </div>
    </div>
    
    <!-- Quick Stats -->
    {% if passwords %}
    <div class="stats-section">
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-key"></i>
                </div>
                <div class="stat-info">
                    <div class="stat-number">{{ password_count }}</div>
                    <div class="stat-label">Total Passwords</div>
                </div>
            </div>
            <div class="stat-card" id="recentStat">
                <div class="stat-icon">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="stat-info">
                    <div class="stat-number" id="recentCount">0</div>
                    <div class="stat-label">Added This Week</div>
                </div>
            </div>
            <div class="stat-card" id="securityStat">
                <div class="stat-icon">
                    <i class="fas fa-shield-alt"></i>
                </div>
                <div class="stat-info">
                    <div class="stat-number" id="securityScore">--</div>
                    <div class="stat-label">Security Score</div>
                </div>
            </div>
            <div class="stat-card" onclick="showLastAccess()">
                <div class="stat-icon">
                    <i class="fas fa-eye"></i>
                </div>
                <div class="stat-info">
                    <div class="stat-number" id="lastAccessCount">0</div>
                    <div class="stat-label">Recent Access</div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Search and Filter -->
    <div class="search-section">
        <form class="search-form" method="GET" action="{{ url_for('search') }}">
            <div class="search-input-group">
                <i class="fas fa-search"></i>
                <input 
                    type="text" 
                    name="q" 
                    placeholder="Search passwords by website, username, or remarks..."
                    value="{{ request.args.get('q', '') }}"
                >
                <button type="submit" class="btn-search">Search</button>
            </div>
        </form>
        
        <div class="filter-options">
            <button class="filter-btn active" onclick="filterPasswords('all')">
                <i class="fas fa-list"></i> All ({{ password_count }})
            </button>
            <button class="filter-btn" onclick="filterPasswords('recent')">
                <i class="fas fa-clock"></i> Recent
            </button>
            <button class="filter-btn" onclick="filterPasswords('favorites')">
                <i class="fas fa-star"></i> Favorites
            </button>
        </div>
        
        <!-- Bulk Actions Bar -->
        <div id="bulkActionsBar" class="bulk-actions-bar" style="display: none;">
            <div class="bulk-info">
                <span id="selectedCount">0</span> passwords selected
            </div>
            <div class="bulk-buttons">
                <button class="btn-secondary" onclick="exportSelected()">
                    <i class="fas fa-download"></i> Export Selected
                </button>
                <button class="btn-danger" onclick="deleteSelected()">
                    <i class="fas fa-trash"></i> Delete Selected
                </button>
                <button class="btn-secondary" onclick="clearSelection()">
                    <i class="fas fa-times"></i> Clear Selection
                </button>
            </div>
        </div>
        
        <!-- Security Reminders -->
        <div id="securityReminders" class="security-reminders" style="display: none;"></div>
    </div>
    
    {% if passwords %}
    <!-- Password List -->
    <div class="password-list">
        <div class="list-header">
            <div class="selection-controls">
                <div class="checkbox-group">
                    <input type="checkbox" id="selectAll" onchange="toggleSelectAll(this.checked)">
                    <label for="selectAll">Select All</label>
                </div>
            </div>
            
            <div class="sort-options">
                <label for="sortBy">Sort by:</label>
                <select id="sortBy" onchange="sortPasswords(this.value)">
                    <option value="website">Website (A-Z)</option>
                    <option value="website-desc">Website (Z-A)</option>
                    <option value="date-new">Newest First</option>
                    <option value="date-old">Oldest First</option>
                    <option value="username">Username</option>
                </select>
            </div>
            
            <div class="view-options">
                <button class="view-btn active" onclick="setView('list')" title="List View">
                    <i class="fas fa-list"></i>
                </button>
                <button class="view-btn" onclick="setView('grid')" title="Grid View">
                    <i class="fas fa-th"></i>
                </button>
            </div>
        </div>
        
        <div id="passwordContainer" class="password-container list-view">
            {% for password in passwords %}
            <div class="password-item" data-website="{{ password.website.lower() }}" data-username="{{ password.username.lower() }}" data-date="{{ password.created_at }}" data-id="{{ password.id }}">
                <div class="password-item-header">
                    <div class="password-checkbox">
                        <input type="checkbox" class="password-select" data-id="{{ password.id }}" onchange="updateSelection()">
                    </div>
                    <div class="password-icon">
                        <i class="fas fa-globe"></i>
                    </div>
                    <div class="password-info">
                        <h3 class="password-website">{{ password.website }}</h3>
                        <p class="password-username">{{ password.username }}</p>
                        {% if password.remarks %}
                        <p class="password-remarks">{{ password.remarks[:100] }}{% if password.remarks|length > 100 %}...{% endif %}</p>
                        {% endif %}
                    </div>
                    <div class="password-meta">
                        <span class="password-date">{{ password.created_at.strftime('%Y-%m-%d') if password.created_at else 'Unknown' }}</span>
                    </div>
                </div>
                
                <div class="password-actions">
                    <button class="action-btn" onclick="copyToClipboard('{{ password.username }}', 'Username copied!')" title="Copy Username">
                        <i class="fas fa-user"></i>
                    </button>
                    <button class="action-btn" onclick="copyPassword({{ password.id }})" title="Copy Password">
                        <i class="fas fa-key"></i>
                    </button>
                    <button class="action-btn" onclick="viewPassword({{ password.id }})" title="View Details">
                        <i class="fas fa-eye"></i>
                    </button>
                    <a href="{{ url_for('edit_password', password_id=password.id) }}" class="action-btn" title="Edit">
                        <i class="fas fa-edit"></i>
                    </a>
                    <button class="action-btn delete-btn" onclick="confirmDelete({{ password.id }}, '{{ password.website }}')" title="Delete">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    
    {% else %}
    <!-- Empty State -->
    <div class="empty-state">
        <div class="empty-icon">
            <i class="fas fa-key"></i>
        </div>
        <h2>No passwords yet</h2>
        <p>Get started by adding your first password. Your data is encrypted and stored securely on your device.</p>
        <a href="{{ url_for('add_password') }}" class="btn-primary">
            <i class="fas fa-plus"></i>
            Add Your First Password
        </a>
    </div>
    {% endif %}
</div>

<!-- Password Details Modal -->
<div id="passwordModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="modalTitle">Password Details</h2>
            <button class="modal-close" onclick="closeModal('passwordModal')">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <div class="password-details">
                <div class="detail-group">
                    <label>Website:</label>
                    <span id="modalWebsite"></span>
                </div>
                <div class="detail-group">
                    <label>Username:</label>
                    <div class="copy-group">
                        <span id="modalUsername"></span>
                        <button class="copy-btn" onclick="copyModalField('modalUsername', 'Username copied!')">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                </div>
                <div class="detail-group">
                    <label>Password:</label>
                    <div class="copy-group">
                        <span id="modalPassword" class="password-hidden">••••••••••••</span>
                        <button class="copy-btn" onclick="copyModalField('modalPassword', 'Password copied!')">
                            <i class="fas fa-copy"></i>
                        </button>
                        <button class="toggle-btn" onclick="toggleModalPassword()">
                            <i class="fas fa-eye" id="modalToggleIcon"></i>
                        </button>
                    </div>
                </div>
                <div class="detail-group">
                    <label>Remarks:</label>
                    <span id="modalRemarks"></span>
                </div>
                <div class="detail-group">
                    <label>Created:</label>
                    <span id="modalCreated"></span>
                </div>
                <div class="detail-group">
                    <label>Last Updated:</label>
                    <span id="modalUpdated"></span>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <a id="editPasswordBtn" href="#" class="btn-primary">
                <i class="fas fa-edit"></i> Edit
            </a>
            <button class="btn-secondary" onclick="closeModal('passwordModal')">Close</button>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteModal" class="modal">
    <div class="modal-content modal-sm">
        <div class="modal-header">
            <h2>Confirm Deletion</h2>
            <button class="modal-close" onclick="closeModal('deleteModal')">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <div class="delete-warning">
                <i class="fas fa-exclamation-triangle"></i>
                <p>Are you sure you want to delete the password for <strong id="deleteWebsite"></strong>?</p>
                <p class="warning-text">This action cannot be undone.</p>
            </div>
        </div>
        <div class="modal-footer">
            <form id="deleteForm" method="POST" style="display: inline;">
                <button type="submit" class="btn-danger">
                    <i class="fas fa-trash"></i> Delete
                </button>
            </form>
            <button class="btn-secondary" onclick="closeModal('deleteModal')">Cancel</button>
        </div>
    </div>
</div>

<script>
let currentPasswords = [];
let currentPasswordData = null;

// Initialize password data and stats
document.addEventListener('DOMContentLoaded', function() {
    currentPasswords = Array.from(document.querySelectorAll('.password-item')).map(item => ({
        element: item,
        website: item.dataset.website,
        username: item.dataset.username,
        date: item.dataset.date
    }));
    
    calculateStats();
    checkSecurityReminders();
});

function filterPasswords(filter) {
    const items = document.querySelectorAll('.password-item');
    const filterBtns = document.querySelectorAll('.filter-btn');
    
    // Update active filter button
    filterBtns.forEach(btn => btn.classList.remove('active'));
    document.querySelector(`[onclick="filterPasswords('${filter}')"]`).classList.add('active');
    
    const now = new Date();
    const oneWeekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
    
    items.forEach(item => {
        let show = true;
        
        if (filter === 'recent') {
            const itemDate = new Date(item.dataset.date);
            show = itemDate >= oneWeekAgo;
        } else if (filter === 'favorites') {
            // For now, just show all since we don't have favorites implemented
            show = false;
        }
        
        item.style.display = show ? 'block' : 'none';
    });
}

function sortPasswords(sortBy) {
    const container = document.getElementById('passwordContainer');
    const items = Array.from(container.querySelectorAll('.password-item'));
    
    items.sort((a, b) => {
        switch(sortBy) {
            case 'website':
                return a.dataset.website.localeCompare(b.dataset.website);
            case 'website-desc':
                return b.dataset.website.localeCompare(a.dataset.website);
            case 'username':
                return a.dataset.username.localeCompare(b.dataset.username);
            case 'date-new':
                return new Date(b.dataset.date) - new Date(a.dataset.date);
            case 'date-old':
                return new Date(a.dataset.date) - new Date(b.dataset.date);
            default:
                return 0;
        }
    });
    
    // Re-append sorted items
    items.forEach(item => container.appendChild(item));
}

function setView(view) {
    const container = document.getElementById('passwordContainer');
    const viewBtns = document.querySelectorAll('.view-btn');
    
    // Update active view button
    viewBtns.forEach(btn => btn.classList.remove('active'));
    document.querySelector(`[onclick="setView('${view}')"]`).classList.add('active');
    
    // Update container class
    container.className = `password-container ${view}-view`;
}

function copyToClipboard(text, message = 'Copied to clipboard!') {
    navigator.clipboard.writeText(text).then(() => {
        showToast(message, 'success');
    }).catch(err => {
        showToast('Failed to copy to clipboard', 'error');
        console.error('Copy failed:', err);
    });
}

function copyPassword(passwordId) {
    // In a real implementation, you'd fetch the password from the server
    // For security, passwords shouldn't be stored in the client
    fetch(`/api/get_password/${passwordId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                copyToClipboard(data.password, 'Password copied!');
            } else {
                showToast('Failed to copy password', 'error');
            }
        })
        .catch(error => {
            showToast('Error copying password', 'error');
            console.error('Error:', error);
        });
}

function viewPassword(passwordId) {
    // Fetch password details from server
    fetch(`/api/get_password/${passwordId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                currentPasswordData = data.password;
                showPasswordModal(data.password);
            } else {
                showToast('Failed to load password details', 'error');
            }
        })
        .catch(error => {
            showToast('Error loading password details', 'error');
            console.error('Error:', error);
        });
}

function showPasswordModal(password) {
    document.getElementById('modalTitle').textContent = `Password Details - ${password.website}`;
    document.getElementById('modalWebsite').textContent = password.website;
    document.getElementById('modalUsername').textContent = password.username;
    document.getElementById('modalPassword').textContent = '••••••••••••';
    document.getElementById('modalPassword').dataset.actualPassword = password.password;
    document.getElementById('modalRemarks').textContent = password.remarks || 'No remarks';
    document.getElementById('modalCreated').textContent = password.created_at ? new Date(password.created_at).toLocaleString() : 'Unknown';
    document.getElementById('modalUpdated').textContent = password.updated_at ? new Date(password.updated_at).toLocaleString() : 'Unknown';
    document.getElementById('editPasswordBtn').href = `/edit_password/${password.id}`;
    
    openModal('passwordModal');
}

function toggleModalPassword() {
    const passwordSpan = document.getElementById('modalPassword');
    const toggleIcon = document.getElementById('modalToggleIcon');
    
    if (passwordSpan.classList.contains('password-hidden')) {
        passwordSpan.textContent = passwordSpan.dataset.actualPassword;
        passwordSpan.classList.remove('password-hidden');
        toggleIcon.className = 'fas fa-eye-slash';
    } else {
        passwordSpan.textContent = '••••••••••••';
        passwordSpan.classList.add('password-hidden');
        toggleIcon.className = 'fas fa-eye';
    }
}

function copyModalField(fieldId, message) {
    const field = document.getElementById(fieldId);
    let textToCopy = field.textContent;
    
    // If it's the password field and it's hidden, use the actual password
    if (fieldId === 'modalPassword' && field.classList.contains('password-hidden')) {
        textToCopy = field.dataset.actualPassword;
    }
    
    copyToClipboard(textToCopy, message);
}

function confirmDelete(passwordId, website) {
    document.getElementById('deleteWebsite').textContent = website;
    document.getElementById('deleteForm').action = `/delete_password/${passwordId}`;
    openModal('deleteModal');
}

function calculateStats() {
    const now = new Date();
    const oneWeekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
    
    // Calculate recent passwords (added this week)
    const recentPasswords = currentPasswords.filter(password => {
        const passwordDate = new Date(password.date);
        return passwordDate >= oneWeekAgo;
    });
    
    // Update recent count
    const recentCountEl = document.getElementById('recentCount');
    if (recentCountEl) {
        recentCountEl.textContent = recentPasswords.length;
    }
    
    // Calculate basic security score (this would be more sophisticated in a real implementation)
    const totalPasswords = currentPasswords.length;
    let securityScore = 85; // Base score
    
    if (totalPasswords < 5) securityScore -= 15;
    if (recentPasswords.length === 0 && totalPasswords > 10) securityScore -= 10;
    
    const securityScoreEl = document.getElementById('securityScore');
    if (securityScoreEl) {
        securityScoreEl.textContent = securityScore + '%';
        // Color code the security score
        const statCard = securityScoreEl.closest('.stat-card');
        if (securityScore >= 80) {
            statCard.style.borderLeftColor = 'var(--success)';
        } else if (securityScore >= 60) {
            statCard.style.borderLeftColor = 'var(--warning)';
        } else {
            statCard.style.borderLeftColor = 'var(--danger)';
        }
    }
    
    // Update last access count (simulated for now)
    const lastAccessEl = document.getElementById('lastAccessCount');
    if (lastAccessEl) {
        // This would track actual access in a real implementation
        lastAccessEl.textContent = Math.min(recentPasswords.length, 5);
    }
}

function showLastAccess() {
    showToast('Last access tracking feature coming soon!', 'info');
}

// Bulk operations
function toggleSelectAll(isChecked) {
    const checkboxes = document.querySelectorAll('.password-select');
    checkboxes.forEach(checkbox => {
        checkbox.checked = isChecked;
        const item = checkbox.closest('.password-item');
        if (isChecked) {
            item.classList.add('selected');
        } else {
            item.classList.remove('selected');
        }
    });
    updateSelection();
}

function updateSelection() {
    const checkboxes = document.querySelectorAll('.password-select');
    const checkedBoxes = document.querySelectorAll('.password-select:checked');
    const selectedCount = checkedBoxes.length;
    
    // Update selected count
    document.getElementById('selectedCount').textContent = selectedCount;
    
    // Show/hide bulk actions bar
    const bulkActionsBar = document.getElementById('bulkActionsBar');
    if (selectedCount > 0) {
        bulkActionsBar.style.display = 'flex';
    } else {
        bulkActionsBar.style.display = 'none';
    }
    
    // Update select all checkbox
    const selectAllCheckbox = document.getElementById('selectAll');
    selectAllCheckbox.indeterminate = selectedCount > 0 && selectedCount < checkboxes.length;
    selectAllCheckbox.checked = selectedCount === checkboxes.length;
    
    // Update item styling
    checkboxes.forEach(checkbox => {
        const item = checkbox.closest('.password-item');
        if (checkbox.checked) {
            item.classList.add('selected');
        } else {
            item.classList.remove('selected');
        }
    });
}

function clearSelection() {
    const checkboxes = document.querySelectorAll('.password-select');
    checkboxes.forEach(checkbox => {
        checkbox.checked = false;
        checkbox.closest('.password-item').classList.remove('selected');
    });
    updateSelection();
}

function exportSelected() {
    const selectedIds = Array.from(document.querySelectorAll('.password-select:checked'))
        .map(checkbox => checkbox.dataset.id);
    
    if (selectedIds.length === 0) {
        showToast('Please select passwords to export', 'warning');
        return;
    }
    
    showToast(`Export feature for ${selectedIds.length} passwords coming soon!`, 'info');
}

function deleteSelected() {
    const selectedIds = Array.from(document.querySelectorAll('.password-select:checked'))
        .map(checkbox => checkbox.dataset.id);
    
    if (selectedIds.length === 0) {
        showToast('Please select passwords to delete', 'warning');
        return;
    }
    
    if (confirm(`Are you sure you want to delete ${selectedIds.length} selected passwords? This action cannot be undone.`)) {
        // In a real implementation, you would send these IDs to the server for bulk deletion
        showToast(`Bulk delete feature for ${selectedIds.length} passwords coming soon!`, 'info');
    }
}

// Security reminders
function checkSecurityReminders() {
    const reminders = [];
    const now = new Date();
    const sixMonthsAgo = new Date(now.getTime() - 6 * 30 * 24 * 60 * 60 * 1000);
    const oneYearAgo = new Date(now.getTime() - 365 * 24 * 60 * 60 * 1000);
    
    // Check for old passwords
    const oldPasswords = currentPasswords.filter(password => {
        const passwordDate = new Date(password.date);
        return passwordDate < sixMonthsAgo;
    });
    
    const veryOldPasswords = currentPasswords.filter(password => {
        const passwordDate = new Date(password.date);
        return passwordDate < oneYearAgo;
    });
    
    // Critical reminder for very old passwords
    if (veryOldPasswords.length > 0) {
        reminders.push({
            type: 'critical',
            icon: 'exclamation-triangle',
            title: 'Critical Security Alert',
            message: `${veryOldPasswords.length} passwords are over 1 year old and should be updated immediately for security.`,
            actions: [
                { text: 'Update Now', action: () => updateOldPasswords(veryOldPasswords) },
                { text: 'View List', action: () => showOldPasswordsList(veryOldPasswords) }
            ]
        });
    } else if (oldPasswords.length > 0) {
        // Warning for moderately old passwords
        reminders.push({
            type: 'warning',
            icon: 'clock',
            title: 'Password Update Recommended',
            message: `${oldPasswords.length} passwords are over 6 months old. Consider updating them for better security.`,
            actions: [
                { text: 'Review', action: () => showOldPasswordsList(oldPasswords) }
            ]
        });
    }
    
    // Check for low password count
    if (currentPasswords.length < 3) {
        reminders.push({
            type: 'info',
            icon: 'info-circle',
            title: 'Getting Started',
            message: 'Add more passwords to fully secure your digital life. Consider importing from your browser.',
            actions: [
                { text: 'Add Password', action: () => window.location.href = '/add_password' },
                { text: 'Import', action: () => window.location.href = '/backup' }
            ]
        });
    }
    
    // Check for potential duplicate websites (simplified check)
    const websites = currentPasswords.map(p => p.website.toLowerCase());
    const duplicateWebsites = websites.filter((site, index) => websites.indexOf(site) !== index);
    
    if (duplicateWebsites.length > 0) {
        reminders.push({
            type: 'warning',
            icon: 'copy',
            title: 'Duplicate Accounts Detected',
            message: `You have multiple accounts for some websites. Consider consolidating or organizing them better.`,
            actions: [
                { text: 'Review', action: () => showDuplicates() }
            ]
        });
    }
    
    displaySecurityReminders(reminders);
}

function displaySecurityReminders(reminders) {
    const container = document.getElementById('securityReminders');
    
    if (reminders.length === 0) {
        container.style.display = 'none';
        return;
    }
    
    container.innerHTML = reminders.map(reminder => `
        <div class="security-reminder ${reminder.type}">
            <div class="reminder-icon">
                <i class="fas fa-${reminder.icon}"></i>
            </div>
            <div class="reminder-content">
                <div class="reminder-title">${reminder.title}</div>
                <div class="reminder-message">${reminder.message}</div>
            </div>
            <div class="reminder-actions">
                ${reminder.actions.map(action => `
                    <button class="btn-primary" onclick="(${action.action})()">${action.text}</button>
                `).join('')}
                <button class="reminder-dismiss" onclick="dismissReminder(this)" title="Dismiss">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
    `).join('');
    
    container.style.display = 'block';
}

function dismissReminder(button) {
    const reminder = button.closest('.security-reminder');
    reminder.style.animation = 'slideUp 0.3s ease';
    setTimeout(() => {
        reminder.remove();
        
        // Hide container if no reminders left
        const container = document.getElementById('securityReminders');
        if (!container.querySelectorAll('.security-reminder').length) {
            container.style.display = 'none';
        }
    }, 300);
}

function updateOldPasswords(oldPasswords) {
    showToast(`Found ${oldPasswords.length} old passwords. Password update wizard coming soon!`, 'info');
}

function showOldPasswordsList(oldPasswords) {
    const websites = oldPasswords.map(p => p.website).join(', ');
    alert(`Old passwords found for: ${websites}\n\nConsider updating these passwords for better security.`);
}

function showDuplicates() {
    showToast('Duplicate detection feature coming soon!', 'info');
}

function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    toast.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check' : type === 'error' ? 'times' : 'info'}"></i>
        <span>${message}</span>
    `;
    
    document.body.appendChild(toast);
    
    // Animate in
    setTimeout(() => toast.classList.add('show'), 100);
    
    // Remove after 3 seconds
    setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}
</script>
{% endblock %}