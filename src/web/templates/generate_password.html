{% extends "base.html" %}

{% block title %}Generate Password - Personal Password Manager{% endblock %}

{% block extra_css %}
<style>
.generator-card {
    background-color: var(--bg-surface);
    border-radius: var(--radius-lg);
    box-shadow: 0 2px 8px var(--shadow-light);
    padding: var(--spacing-xl);
    margin-bottom: var(--spacing-xl);
}

.generated-password {
    background-color: var(--bg-secondary);
    border: 2px solid var(--border-color);
    border-radius: var(--radius-md);
    padding: var(--spacing-lg);
    margin: var(--spacing-lg) 0;
    text-align: center;
}

.password-display {
    font-family: 'Courier New', monospace;
    font-size: var(--font-size-lg);
    font-weight: bold;
    color: var(--primary);
    word-break: break-all;
    margin-bottom: var(--spacing-md);
}

.generator-options {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: var(--spacing-lg);
    margin-bottom: var(--spacing-lg);
}

.option-group {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-sm);
}

.slider-group {
    display: flex;
    align-items: center;
    gap: var(--spacing-md);
}

.slider {
    flex: 1;
    -webkit-appearance: none;
    height: 6px;
    border-radius: 3px;
    background: var(--bg-secondary);
    outline: none;
}

.slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: var(--primary);
    cursor: pointer;
}

.length-display {
    min-width: 3rem;
    text-align: center;
    font-weight: bold;
    color: var(--primary);
}
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <div class="dashboard-header">
        <div class="dashboard-title">
            <h1><i class="fas fa-dice"></i> Password Generator</h1>
            <p>Generate secure passwords with customizable options</p>
        </div>
        <div class="dashboard-actions">
            <a href="{{ url_for('dashboard') }}" class="btn-secondary">
                <i class="fas fa-arrow-left"></i> Back to Dashboard
            </a>
        </div>
    </div>
    
    <div class="generator-card">
        <h2><i class="fas fa-cog"></i> Generation Options</h2>
        
        <form id="generatorForm">
            <div class="generator-options">
                <div class="option-group">
                    <label><i class="fas fa-ruler"></i> Password Length</label>
                    <div class="slider-group">
                        <input type="range" id="lengthSlider" class="slider" min="6" max="128" value="16">
                        <span id="lengthDisplay" class="length-display">16</span>
                    </div>
                </div>
                
                <div class="option-group">
                    <label><i class="fas fa-layer-group"></i> Generation Method</label>
                    <select id="methodSelect" class="form-control">
                        <option value="random">Random Characters</option>
                        <option value="memorable">Memorable Words</option>
                        <option value="pronounceable">Pronounceable</option>
                    </select>
                </div>
            </div>
            
            <div class="generator-options" id="characterOptions">
                <div class="option-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="lowercase" checked>
                        <label for="lowercase">Lowercase (a-z)</label>
                    </div>
                </div>
                
                <div class="option-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="uppercase" checked>
                        <label for="uppercase">Uppercase (A-Z)</label>
                    </div>
                </div>
                
                <div class="option-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="digits" checked>
                        <label for="digits">Numbers (0-9)</label>
                    </div>
                </div>
                
                <div class="option-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="symbols" checked>
                        <label for="symbols">Symbols (!@#$%)</label>
                    </div>
                </div>
            </div>
            
            <div class="dashboard-actions">
                <button type="button" id="generateBtn" class="btn-primary">
                    <i class="fas fa-dice"></i> Generate Password
                </button>
                <button type="button" id="copyBtn" class="btn-secondary" disabled>
                    <i class="fas fa-copy"></i> Copy to Clipboard
                </button>
            </div>
        </form>
    </div>
    
    <div id="passwordResult" class="generator-card" style="display: none;">
        <h2><i class="fas fa-key"></i> Generated Password</h2>
        <div class="generated-password">
            <div id="passwordDisplay" class="password-display"></div>
            <div id="strengthInfo" class="password-strength">
                <div class="strength-bar">
                    <div id="strengthFill" class="strength-fill" style="width: 0%"></div>
                </div>
                <div id="strengthText" class="strength-text"></div>
            </div>
        </div>
        
        <div class="dashboard-actions">
            <button type="button" id="usePasswordBtn" class="btn-success" onclick="useGeneratedPassword()">
                <i class="fas fa-check"></i> Use This Password
            </button>
            <button type="button" onclick="generateNewPassword()" class="btn-info">
                <i class="fas fa-redo"></i> Generate Another
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentPassword = '';

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    updateLengthDisplay();
    toggleCharacterOptions();
    
    // Event listeners
    document.getElementById('lengthSlider').addEventListener('input', updateLengthDisplay);
    document.getElementById('methodSelect').addEventListener('change', toggleCharacterOptions);
    document.getElementById('generateBtn').addEventListener('click', generateNewPassword);
    document.getElementById('copyBtn').addEventListener('click', copyToClipboard);
});

function updateLengthDisplay() {
    const slider = document.getElementById('lengthSlider');
    const display = document.getElementById('lengthDisplay');
    display.textContent = slider.value;
}

function toggleCharacterOptions() {
    const method = document.getElementById('methodSelect').value;
    const charOptions = document.getElementById('characterOptions');
    charOptions.style.display = method === 'random' ? 'grid' : 'none';
}

async function generateNewPassword() {
    const generateBtn = document.getElementById('generateBtn');
    generateBtn.disabled = true;
    generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
    
    try {
        const options = {
            length: parseInt(document.getElementById('lengthSlider').value),
            method: document.getElementById('methodSelect').value,
            include_lowercase: document.getElementById('lowercase').checked,
            include_uppercase: document.getElementById('uppercase').checked,
            include_digits: document.getElementById('digits').checked,
            include_symbols: document.getElementById('symbols').checked
        };
        
        const response = await fetch('/api/generate_password', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(options)
        });
        
        const result = await response.json();
        
        if (result.success) {
            displayPassword(result.password, result.strength);
        } else {
            showToast('Error generating password: ' + result.error, 'error');
        }
    } catch (error) {
        showToast('Error generating password: ' + error.message, 'error');
    } finally {
        generateBtn.disabled = false;
        generateBtn.innerHTML = '<i class="fas fa-dice"></i> Generate Password';
    }
}

function displayPassword(password, strength) {
    currentPassword = password;
    
    document.getElementById('passwordDisplay').textContent = password;
    document.getElementById('passwordResult').style.display = 'block';
    document.getElementById('copyBtn').disabled = false;
    
    // Update strength indicator
    if (strength) {
        const strengthFill = document.getElementById('strengthFill');
        const strengthText = document.getElementById('strengthText');
        
        strengthFill.style.width = (strength.score / 5) * 100 + '%';
        strengthFill.className = 'strength-fill strength-' + strength.level.toLowerCase().replace(' ', '_');
        strengthText.textContent = strength.level + ' (' + strength.score + '/5)';
    }
    
    // Scroll to result
    document.getElementById('passwordResult').scrollIntoView({ behavior: 'smooth' });
}

async function copyToClipboard() {
    if (!currentPassword) return;
    
    try {
        await navigator.clipboard.writeText(currentPassword);
        showToast('Password copied to clipboard!', 'success');
        
        const copyBtn = document.getElementById('copyBtn');
        const originalText = copyBtn.innerHTML;
        copyBtn.innerHTML = '<i class="fas fa-check"></i> Copied!';
        setTimeout(() => {
            copyBtn.innerHTML = originalText;
        }, 2000);
    } catch (error) {
        showToast('Failed to copy password', 'error');
    }
}

function useGeneratedPassword() {
    if (window.opener && window.opener.document) {
        // If opened from password form, fill the password field
        const passwordField = window.opener.document.querySelector('input[name="password"]');
        if (passwordField) {
            passwordField.value = currentPassword;
            passwordField.dispatchEvent(new Event('input'));
            window.close();
            return;
        }
    }
    
    // Otherwise redirect to add password page with the password
    const addUrl = new URL('{{ url_for("add_password") }}', window.location.origin);
    addUrl.searchParams.set('generated_password', currentPassword);
    window.location.href = addUrl.toString();
}

function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `toast toast-${type} show`;
    toast.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check' : type === 'error' ? 'times' : 'info'}"></i>
        ${message}
    `;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}
</script>
{% endblock %}